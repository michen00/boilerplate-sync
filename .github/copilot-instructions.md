# GitHub Copilot Instructions

You are working on `boilerplate-sync`, a GitHub Action that syncs files from source repositories using a pull model.

## Critical Rules

**NEVER edit files in `dist/` manually.** The `dist/` directory is generated by `npm run build`. Always:

1. Edit source files in `src/`
2. Run `npm run build` to regenerate `dist/`
3. Commit both `src/` and `dist/` changes together

**TypeScript strict mode is enabled.** Avoid `any`. Always handle `undefined` and `null` explicitly.

## Code Patterns

### Error Handling

Use `ConfigError` for user-facing validation errors:

```typescript
// ✅ GOOD
if (typeof obj.local_path !== 'string' || !obj.local_path.trim()) {
  throw new ConfigError(
    `Source ${sourceIndex + 1}, file ${fileIndex + 1}: 'local_path' is required`,
  );
}

// ❌ BAD
if (!obj.local_path) {
  throw new Error('Invalid path');
}
```

### Async Functions

Always use `async/await`, never raw promises:

```typescript
// ✅ GOOD
async function fetchFile(config: NormalizedFileSyncConfig): Promise<FetchResult> {
  const content = await octokit.repos.getContent({ ... });
  return { content, resolvedRef };
}

// ❌ BAD
function fetchFile(config: NormalizedFileSyncConfig): Promise<FetchResult> {
  return octokit.repos.getContent({ ... }).then(content => ({ content }));
}
```

### Type Definitions

Use interfaces from `src/sources/types.ts`. Prefer `NormalizedFileSyncConfig` over deprecated `FileSyncConfig`:

```typescript
// ✅ GOOD
import type { NormalizedFileSyncConfig, SyncResult } from './sources/types';

function syncFile(config: NormalizedFileSyncConfig): Promise<SyncResult> {
  // ...
}

// ❌ BAD
function syncFile(config: { local_path: string; source_path: string }) {
  // ...
}
```

### Action Inputs/Outputs

When adding new inputs or outputs:

1. Update `action.yml`
2. Update `ActionInputs` or `ActionOutputs` types in `src/sources/types.ts`
3. Update `getInputs()` in `src/config.ts` for inputs
4. Update `setOutputs()` in `src/index.ts` for outputs

## Architecture

- **`src/index.ts`**: Entry point. Calls `getInputs()`, `syncFiles()`, sets outputs
- **`src/config.ts`**: Parses YAML `sources` input, validates, normalizes to `NormalizedFileSyncConfig[]`
- **`src/sync.ts`**: Orchestrates file syncing. Expands globs, fetches files, writes to workspace
- **`src/sources/github.ts`**: GitHub API client. Implements `FileSource` interface
- **`src/report.ts`**: Generates GitHub step summary markdown

## Testing

- Tests live in `tests/` directory
- Use `vitest` for testing
- Run `npm run test` before committing
- When fixing bugs, add/update tests in `tests/`

## Common Commands

```bash
npm run build      # Build dist/ from src/
npm run test       # Run tests once
npm run lint       # ESLint check
npm run type-check # TypeScript type checking
make check         # Run all checks (pre-commit, lint, type-check, test)
```

## When Adding Features

1. Update types in `src/sources/types.ts` if needed
2. Implement logic in appropriate module (`config.ts`, `sync.ts`, etc.)
3. Add tests in `tests/`
4. Update `action.yml` if inputs/outputs change
5. Update `README.md` if behavior changes
6. Run `npm run build` and commit `dist/` changes
