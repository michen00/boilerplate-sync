---
name: Sync boilerplate files

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9am
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync boilerplate files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Sync files
        id: sync
        uses: michen00/boilerplate-sync@v1
        with:
          sources: |
            - source: michen00/template
              # ref: main
              default_files:
                - .github/ISSUE_TEMPLATE/*.md
                - .gitlint
                - .editorconfig
                - .github/workflows/lint-github-actions.yml
              # file_pairs:
              #   - local_path: .gitlint
              #     source_path: .dotfiles/.gitlint
              #   - local_path: .editorconfig
              #     source_path: editor-configs/.editorconfig
              #   - local_path: .github/workflows/lint-github-actions.yml
              #     source_path: .github/workflows/lint-actions.yml
            # - source: your-org/private-repo
            #   source-token: ${{ secrets.BOILERPLATE_PAT }}
            #   default_files: [file1, file2]
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: 'true'
          # create-missing: 'false'

      - name: Build PR body
        id: pr-body
        if: steps.sync.outputs.has-changes == 'true'
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const summary = JSON.parse(`${{ steps.sync.outputs.summary }}`);

            let body = `## Boilerplate Sync\n\nThis PR updates project files from their boilerplate sources.\n\n`;

            // Updated + Created files
            const updated = [...summary.updated, ...summary.created];
            if (updated.length > 0) {
              body += `<details>\n<summary>Updated (${updated.length} file${updated.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of updated) {
                body += `- \`${r.config.local_path}\`\n`;
              }
              body += `\n</details>\n\n`;
            }

            // Skipped files
            if (summary.skipped.length > 0) {
              body += `<details>\n<summary>Skipped (${summary.skipped.length} file${summary.skipped.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of summary.skipped) {
                const reason = r.error || 'No changes detected';
                body += `- \`${r.config.local_path}\` - ${reason}\n`;
              }
              body += `\n</details>\n\n`;
            }

            // Failed files (expanded by default)
            if (summary.failed.length > 0) {
              body += `<details open>\n<summary>Failed (${summary.failed.length} file${summary.failed.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of summary.failed) {
                body += `- \`${r.config.local_path}\` - ${r.error}\n`;
              }
              body += `\n</details>\n\n`;
            }

            return body;
      - name: Create Pull Request
        if: steps.sync.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: boilerplate-sync/${{ github.run_id }}
          delete-branch: true
          title: 'chore: auto-sync boilerplate files'
          body: ${{ steps.pr-body.outputs.result }}
          labels: |
            boilerplate
            automated
