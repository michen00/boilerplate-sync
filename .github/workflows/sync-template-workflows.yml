---
name: Sync boilerplate files (workflow files)

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9am
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: write
  id-token: write
  pull-requests: write

jobs:
  sync:
    name: Sync boilerplate files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Sync files
        id: sync
        uses: michen00/boilerplate-sync@main
        with:
          sources: |
            - source: michen00/template
              default_files:
                - .editorconfig
                - .github/workflows/bot-automerge.yml
                - .github/workflows/delete-bot-branches-for-closed-prs.yml
                - .github/workflows/lint-github-actions.yml
                - .github/workflows/pre-commit-autoupdate.yml
                - .gitlint
                - .markdownlint.yml
                - .prettierrc
                - .yamllint
                - scripts/update-unreleased.sh
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: 'true'
      - name: Exit if no changes
        if: steps.sync.outputs.has-changes == 'false'
        run: |
          echo '::notice::No changes detected. Exiting.'
          exit 0
      - name: Stage changes
        run: |
          set -e
          git add .
          if git diff --cached --quiet; then
            echo '::error::Sync action reported changes, but no files were staged. ' \
                 'This may indicate gitignore conflicts or other issues.'
            exit 1
          fi
          echo '::notice::Changes staged. Proceeding with commit.'
      - name: Commit changes
        uses: iarekylew00t/verified-bot-commit@v2
        with:
          auto-stage: false
          if-no-commit: error
          update-local: false
          message: 'chore: auto-sync boilerplate files'
          files: |
            **
      - name: Build PR body
        id: pr-body
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const summary = JSON.parse(`${{ steps.sync.outputs.summary }}`);

            let body = `## Boilerplate Sync\n\nThis PR updates project files from their boilerplate sources.\n\n`;

            // Updated + Created files
            const updated = [...summary.updated, ...summary.created];
            if (updated.length > 0) {
              body += `<details>\n<summary>Updated (${updated.length} file${updated.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of updated) {
                body += `- \`${r.config.local_path}\`\n`;
              }
              body += `\n</details>\n\n`;
            }

            // Skipped files
            if (summary.skipped.length > 0) {
              body += `<details>\n<summary>Skipped (${summary.skipped.length} file${summary.skipped.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of summary.skipped) {
                const reason = r.error || 'No changes detected';
                body += `- \`${r.config.local_path}\` - ${reason}\n`;
              }
              body += `\n</details>\n\n`;
            }

            // Failed files (expanded by default)
            if (summary.failed.length > 0) {
              body += `<details open>\n<summary>Failed (${summary.failed.length} file${summary.failed.length === 1 ? '' : 's'})</summary>\n\n`;
              for (const r of summary.failed) {
                body += `- \`${r.config.local_path}\` - ${r.error}\n`;
              }
              body += `\n</details>\n\n`;
            }

            return body;
      - name: Create pull request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: boilerplate-sync/${{ github.run_id }}
          delete-branch: true
          title: 'chore: auto-sync boilerplate files'
          body: ${{ steps.pr-body.outputs.result }}
          labels: |
            automated
            boilerplate
